<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Night Scheduler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .upload-area {
            border: 3px dashed #4facfe;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            background: linear-gradient(45deg, #f8f9ff, #ffffff);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #00f2fe;
            background: linear-gradient(45deg, #f0f7ff, #f8f9ff);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #00f2fe;
            background: linear-gradient(45deg, #e8f4ff, #f0f7ff);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #4facfe;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .schedule {
            margin-top: 30px;
        }

        .day-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .time-slot {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
        }

        .time-slot:last-child {
            border-bottom: none;
        }

        .time-header {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-icon {
            margin-right: 10px;
            color: #4facfe;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .group {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border: 2px solid #e8f4ff;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .group:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.2);
        }

        .group-header {
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .player:last-child {
            border-bottom: none;
        }

        .player-name {
            font-weight: 500;
            color: #333;
        }

        .player-skill {
            background: #4facfe;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .no-groups {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .unassigned-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            border-radius: 15px;
            display: none;
        }

        .unassigned-header {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section, .results-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèì Club Night Scheduler</h1>
            <p>Upload your registration CSV and get perfectly balanced groups</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your CSV file here or click to browse</div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".csv" />
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="error" id="errorMessage"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing registrations and creating groups...</p>
        </div>

        <div class="results-section" id="results">
            <div class="stats" id="stats"></div>
            <div class="schedule" id="schedule"></div>
            <div class="unassigned-section" id="unassignedSection">
                <div class="unassigned-header">‚ö†Ô∏è Unassigned Players</div>
                <div id="unassignedList"></div>
            </div>
        </div>
    </div>

    <script>
        class ClubScheduler {
            constructor() {
                this.players = [];
                this.skillLevels = {
                    'Beginner': 1,
                    'Beginner / Intermediate': 2,
                    'Intermediate': 3,
                    'Intermediate / Advanced': 4,
                    'Advanced': 5
                };
                
                this.scheduleLimits = {
                    'tuesday': {1: 3, 2: 3, 3: 3},
                    'wednesday': {1: 4, 2: 5, 3: 5}
                };
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.processFile(files[0]);
                }
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }

            processFile(file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    this.showError('Please select a CSV file');
                    return;
                }

                this.showLoading();
                this.hideError();

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    complete: (results) => {
                        this.parseData(results.data);
                    },
                    error: (error) => {
                        this.showError('Error parsing CSV: ' + error.message);
                        this.hideLoading();
                    }
                });
            }

            parseData(data) {
                this.players = [];
                
                data.forEach(row => {
                    if (row['Full Name'] && row['Full Name'].trim()) {
                        const player = {
                            name: row['Full Name'].trim(),
                            registration: (row['I want to register for the next Club Night'] || '').trim(),
                            skillLevel: (row['Skill level'] || '').trim(),
                            notes: (row['Notes'] || '').trim()
                        };

                        // Parse which days they want to play
                        if (player.registration.includes('Both')) {
                            player.days = ['tuesday', 'wednesday'];
                        } else if (player.registration.includes('Wednesday') || player.registration.includes('Feyenoord')) {
                            player.days = ['wednesday'];
                        } else if (player.registration.includes('Tuesday')) {
                            player.days = ['tuesday'];
                        } else {
                            player.days = ['wednesday'];
                        }

                        player.timePreferences = this.parseTimePreferences(player.notes);
                        player.partnerPreferences = this.parsePartnerPreferences(player.notes);

                        this.players.push(player);
                    }
                });

                setTimeout(() => {
                    this.createGroups();
                }, 500);
            }

            parseTimePreferences(notes) {
                const preferences = {};
                const notesLower = notes.toLowerCase();

                if (notes.includes('20:00') || notesLower.includes('eerste uur') || notesLower.includes('early')) {
                    preferences.preferredHour = 1;
                } else if (notes.includes('21:00') || notesLower.includes('vanaf 21:00') || notesLower.includes('from 9')) {
                    preferences.preferredHour = 2;
                } else if (notesLower.includes('tweede uur')) {
                    preferences.preferredHour = 2;
                }

                if (notesLower.includes('niet laatste') || notesLower.includes('not last') || notesLower.includes('niet 3e')) {
                    preferences.avoidHour = 3;
                }

                return preferences;
            }

            parsePartnerPreferences(notes) {
                const partners = [];
                const commonNames = ['thorsten', 'sander', 'auke', 'daniel', 'niall', 'lars', 'miriam', 'ian', 'floor', 'quinten', 'mir'];
                const notesLower = notes.toLowerCase();

                commonNames.forEach(name => {
                    if (notesLower.includes(name)) {
                        partners.push(name.charAt(0).toUpperCase() + name.slice(1));
                    }
                });

                return partners;
            }

            getSkillLevelNumeric(skillLevel) {
                return this.skillLevels[skillLevel] || 3;
            }

            createGroups() {
                const schedule = {
                    'tuesday': {1: [], 2: [], 3: []},
                    'wednesday': {1: [], 2: [], 3: []}
                };

                const assignedPlayers = new Set();

                // First, assign players with preferences
                this.assignWithPreferences(schedule, assignedPlayers);

                // Then assign remaining players
                this.assignRemainingPlayers(schedule, assignedPlayers);

                this.displayResults(schedule, assignedPlayers);
            }

            assignWithPreferences(schedule, assignedPlayers) {
                const preferenceResults = this.players.filter(p => 
                    Object.keys(p.timePreferences).length > 0 || p.partnerPreferences.length > 0
                );

                preferenceResults.forEach(player => {
                    if (assignedPlayers.has(player.name)) return;

                    const bestSlot = this.findBestSlotForPlayer(player, schedule, assignedPlayers);
                    if (bestSlot) {
                        const [day, hour] = bestSlot;
                        this.assignPlayerToSlot(player, day, hour, schedule, assignedPlayers);
                    }
                });
            }

            assignRemainingPlayers(schedule, assignedPlayers) {
                const remainingPlayers = this.players.filter(p => !assignedPlayers.has(p.name));
                remainingPlayers.sort((a, b) => this.getSkillLevelNumeric(a.skillLevel) - this.getSkillLevelNumeric(b.skillLevel));

                remainingPlayers.forEach(player => {
                    if (assignedPlayers.has(player.name)) return;

                    const bestSlot = this.findBestSlotForPlayer(player, schedule, assignedPlayers);
                    if (bestSlot) {
                        const [day, hour] = bestSlot;
                        this.assignPlayerToSlot(player, day, hour, schedule, assignedPlayers);
                    }
                });
            }

            findBestSlotForPlayer(player, schedule, assignedPlayers) {
                const bestSlots = [];

                player.days.forEach(day => {
                    [1, 2, 3].forEach(hour => {
                        if (!this.slotRespectsPreferences(player, day, hour)) return;

                        const currentGroups = schedule[day][hour].length;
                        const maxGroups = this.scheduleLimits[day][hour];

                        if (currentGroups < maxGroups) {
                            // Check if can join existing group
                            let canJoinExisting = false;
                            for (const group of schedule[day][hour]) {
                                if (group.length < 6 && this.canJoinGroup(player, group)) {
                                    bestSlots.push([day, hour, 'join', group]);
                                    canJoinExisting = true;
                                    break;
                                }
                            }

                            if (!canJoinExisting && currentGroups < maxGroups) {
                                bestSlots.push([day, hour, 'new', null]);
                            }
                        }
                    });
                });

                if (bestSlots.length === 0) return null;

                // Prefer slots that match time preferences
                const preferred = bestSlots.filter(slot => 
                    player.timePreferences.preferredHour === slot[1]
                );

                return preferred.length > 0 ? preferred[0].slice(0, 2) : bestSlots[0].slice(0, 2);
            }

            slotRespectsPreferences(player, day, hour) {
                const prefs = player.timePreferences;
                return prefs.avoidHour !== hour;
            }

            canJoinGroup(player, group) {
                if (group.length >= 6) return false;

                const playerSkill = this.getSkillLevelNumeric(player.skillLevel);
                const groupSkills = group.map(p => this.getSkillLevelNumeric(p.skillLevel));

                if (groupSkills.length > 0) {
                    const minSkill = Math.min(...groupSkills);
                    const maxSkill = Math.max(...groupSkills);

                    if (playerSkill < minSkill - 1 || playerSkill > maxSkill + 1) {
                        return false;
                    }
                }

                return true;
            }

            assignPlayerToSlot(player, day, hour, schedule, assignedPlayers) {
                // Try to join existing group first
                for (const group of schedule[day][hour]) {
                    if (group.length < 6 && this.canJoinGroup(player, group)) {
                        group.push(player);
                        assignedPlayers.add(player.name);
                        return;
                    }
                }

                // Create new group
                if (schedule[day][hour].length < this.scheduleLimits[day][hour]) {
                    schedule[day][hour].push([player]);
                    assignedPlayers.add(player.name);
                }
            }

            displayResults(schedule, assignedPlayers) {
                this.hideLoading();
                
                const totalAssigned = assignedPlayers.size;
                const totalPlayers = this.players.length;
                
                // Display stats
                this.displayStats(totalAssigned, totalPlayers, schedule);
                
                // Display schedule
                this.displaySchedule(schedule);
                
                // Display unassigned players
                this.displayUnassignedPlayers(assignedPlayers);
                
                document.getElementById('results').style.display = 'block';
            }

            displayStats(totalAssigned, totalPlayers, schedule) {
                const statsContainer = document.getElementById('stats');
                
                let totalGroups = 0;
                Object.values(schedule).forEach(day => {
                    Object.values(day).forEach(hour => {
                        totalGroups += hour.length;
                    });
                });

                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalPlayers}</div>
                        <div class="stat-label">Total Registered</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalAssigned}</div>
                        <div class="stat-label">Players Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalGroups}</div>
                        <div class="stat-label">Groups Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round((totalAssigned/totalPlayers) * 100)}%</div>
                        <div class="stat-label">Assignment Rate</div>
                    </div>
                `;
            }

            displaySchedule(schedule) {
                const scheduleContainer = document.getElementById('schedule');
                const days = {tuesday: 'TUESDAY', wednesday: 'WEDNESDAY'};
                const hours = {1: '20:00-21:00', 2: '21:00-22:00', 3: '22:00-23:00'};
                
                let html = '';
                
                Object.entries(days).forEach(([dayKey, dayName]) => {
                    html += `
                        <div class="day-section">
                            <div class="day-header">${dayName}</div>
                    `;
                    
                    Object.entries(hours).forEach(([hourKey, timeSlot]) => {
                        const groups = schedule[dayKey][parseInt(hourKey)];
                        
                        html += `
                            <div class="time-slot">
                                <div class="time-header">
                                    <span class="time-icon">üïê</span>
                                    ${timeSlot}
                                </div>
                        `;
                        
                        if (groups.length === 0) {
                            html += '<div class="no-groups">No groups scheduled</div>';
                        } else {
                            html += '<div class="groups-container">';
                            groups.forEach((group, index) => {
                                html += `
                                    <div class="group">
                                        <div class="group-header">Group ${index + 1} (${group.length} players)</div>
                                `;
                                group.forEach(player => {
                                    html += `
                                        <div class="player">
                                            <span class="player-name">${player.name}</span>
                                            <span class="player-skill">${player.skillLevel}</span>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                            });
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                });
                
                scheduleContainer.innerHTML = html;
            }

            displayUnassignedPlayers(assignedPlayers) {
                const unassigned = this.players.filter(p => !assignedPlayers.has(p.name));
                const unassignedSection = document.getElementById('unassignedSection');
                const unassignedList = document.getElementById('unassignedList');
                
                if (unassigned.length > 0) {
                    unassignedList.innerHTML = unassigned.map(p => 
                        `<span style="display: inline-block; margin: 5px; padding: 8px 12px; background: rgba(255,255,255,0.7); border-radius: 15px; font-weight: 500;">${p.name} (${p.skillLevel})</span>`
                    ).join('');
                    unassignedSection.style.display = 'block';
                } else {
                    unassignedSection.style.display = 'none';
                }
            }

            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }

            showError(message) {
                const errorElement = document.getElementById('errorMessage');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }
        }

        // Initialize the scheduler when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ClubScheduler();
        });
    </script>
</body>
</html>
